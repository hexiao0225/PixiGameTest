{"version":3,"file":"connection-plugin.min.js","sources":["../src/utils.js","../src/picker.js","../src/index.js"],"sourcesContent":["function toTrainCase(str) {\n    return str.toLowerCase().replace(/ /g, '-');\n}\n\nexport function defaultPath(points, curvature) {\n    const [x1, y1, x2, y2] = points;\n    const hx1 = x1 + Math.abs(x2 - x1) * curvature;\n    const hx2 = x2 - Math.abs(x2 - x1) * curvature;\n\n    return `M ${x1} ${y1} C ${hx1} ${y1} ${hx2} ${y2} ${x2} ${y2}`;\n}\n\nexport function renderPathData(emitter, points, connection) {\n    const data = { points, connection, d: '' };\n    \n    emitter.trigger('connectionpath', data);\n    \n    return data.d || defaultPath(points, 0.4);\n}\n\nexport function updateConnection({ el, d }) {\n    const path = el.querySelector('.connection path');\n\n    if (!path) throw new Error('Path of connection was broken');\n\n    path.setAttribute('d', d);\n}\n\nexport function renderConnection({ el, d, connection }) {\n    const classed = !connection?[]:[\n        'input-' + toTrainCase(connection.input.name),\n        'output-' + toTrainCase(connection.output.name),\n        'socket-input-' + toTrainCase(connection.input.socket.name),\n        'socket-output-' + toTrainCase(connection.output.socket.name)\n    ];\n\n    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg')\n    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path')\n\n    svg.classList.add('connection', ...classed);\n    path.classList.add('main-path');\n    path.setAttribute('d', d);\n\n    svg.appendChild(path);\n    el.appendChild(svg);\n\n    updateConnection({ el, d });\n}","import { renderConnection, renderPathData, updateConnection } from './utils';\n\nexport class Picker {\n\n    constructor(editor) {\n        this.el = document.createElement('div');\n        this.editor = editor;\n        this._output = null;\n    }\n\n    get output() {\n        return this._output;\n    }\n\n    set output(val) {\n        const { area } = this.editor.view;\n\n        this._output = val;\n        if (val !== null) {\n            area.appendChild(this.el);\n            this.renderConnection();\n        } else if (this.el.parentElement) {\n            area.removeChild(this.el)\n            this.el.innerHTML = '';\n        }\n    }\n\n    reset() {\n        this.output = null;\n    }\n\n    pickOutput(output) {\n        if (output && !this.output) {\n            this.output = output;\n        }\n    }\n\n    // eslint-disable-next-line max-statements\n    pickInput(input) {\n        if (this.output === null) {\n            if (input.hasConnection()) {\n                this.output = input.connections[0].output;\n                this.editor.removeConnection(input.connections[0]);\n            }\n            return true;\n        }\n\n        if (!input.multipleConnections && input.hasConnection())\n            this.editor.removeConnection(input.connections[0]);\n        \n        if (!this.output.multipleConnections && this.output.hasConnection())\n            this.editor.removeConnection(this.output.connections[0]);\n        \n        if (this.output.connectedTo(input)) {\n            var connection = input.connections.find(c => c.output === this.output);\n\n            this.editor.removeConnection(connection);\n        }\n\n        this.editor.connect(this.output, input);\n        this.reset();\n    }\n\n    pickConnection(connection) {\n        const { output } = connection;\n\n        this.editor.removeConnection(connection);\n        this.output = output;\n    }\n\n    getPoints() {\n        const mouse = this.editor.view.area.mouse;\n        const node = this.editor.view.nodes.get(this.output.node);\n        const [x1, y1] = node.getSocketPosition(this.output);\n\n        return [x1, y1, mouse.x, mouse.y];\n    }\n\n    updateConnection() {\n        if (!this.output) return;\n\n        const d = renderPathData(this.editor, this.getPoints());\n\n        updateConnection({ el: this.el, d });\n    }\n\n    renderConnection() {\n        if (!this.output) return;\n\n        const d = renderPathData(this.editor, this.getPoints());\n\n        renderConnection({ el: this.el, d, connection: null });\n    }\n\n}","import './index.sass'\nimport { renderConnection, renderPathData, updateConnection } from './utils';\nimport { Picker } from './picker';\n\nclass Flow {\n    constructor(picker) {\n        this.picker = picker;\n        this.locked = false;\n    }\n\n    act({ input, output } = {}) {\n        if (this.locked) return;\n        \n        if (input)\n            this.picker.pickInput(input)\n        else if (output)\n            this.picker.pickOutput(output)\n        else\n            this.picker.reset();\n    }\n\n    once(params) {\n        this.act(params);\n        this.prevent();\n    }\n\n    prevent() {\n        this.locked = true;\n    }\n\n    reset() {\n        this.locked = false;\n    }\n}\n\nfunction install(editor) {\n    editor.bind('connectionpath');\n    \n    const picker = new Picker(editor);\n    const flow = new Flow(picker);\n    \n    editor.on('rendersocket', ({ el, input, output }) => {\n        el._reteConnectionPlugin = { input, output };\n\n        el.addEventListener('pointerdown', e => {\n            editor.view.container.dispatchEvent(new PointerEvent('pointermove', e));\n            e.stopPropagation();\n            flow.once(el._reteConnectionPlugin);\n        });\n        el.addEventListener('click', e => {\n            e.stopPropagation();\n            flow.reset();\n        });\n    });\n\n    window.addEventListener('pointerup', e => {\n        const el = document.elementFromPoint(e.clientX, e.clientY);\n\n        flow.act(el && el._reteConnectionPlugin)\n    });\n    window.addEventListener('pointermove', () => flow.reset());\n\n    editor.on('mousemove', () => picker.updateConnection());\n\n    editor.on('renderconnection', ({ el, connection, points }) => {\n        const d = renderPathData(editor, points, connection);\n\n        el.addEventListener('contextmenu', e => {\n            e.stopPropagation();\n            e.preventDefault();\n            \n            picker.pickConnection(connection);\n        });\n\n        renderConnection({ el, d, connection })\n    });\n\n    editor.on('updateconnection', ({ el, connection, points }) => {\n        const d = renderPathData(editor, points, connection);\n\n        updateConnection({ el, connection, d });\n    });\n}\n\nexport default {\n    name: 'connection',\n    install\n}\nexport { defaultPath } from './utils';"],"names":["toTrainCase","str","toLowerCase","replace","defaultPath","points","curvature","x1","y1","x2","y2","hx1","Math","abs","hx2","renderPathData","emitter","connection","data","d","trigger","updateConnection","el","path","querySelector","Error","setAttribute","renderConnection","classed","input","name","output","socket","svg","document","createElementNS","classList","add","appendChild","Picker","editor","createElement","_output","this","hasConnection","connections","removeConnection","multipleConnections","connectedTo","find","c","_this","connect","reset","mouse","view","area","nodes","get","node","getSocketPosition","x","y","getPoints","val","parentElement","removeChild","innerHTML","Flow","picker","locked","pickInput","pickOutput","params","act","prevent","install","bind","flow","on","_reteConnectionPlugin","addEventListener","e","container","dispatchEvent","PointerEvent","stopPropagation","once","window","elementFromPoint","clientX","clientY","preventDefault","pickConnection"],"mappings":"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"}