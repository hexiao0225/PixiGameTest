{"version":3,"file":"connection-plugin.common.js","sources":["../src/utils.js","../src/picker.js","../src/index.js"],"sourcesContent":["function toTrainCase(str) {\n    return str.toLowerCase().replace(/ /g, '-');\n}\n\nexport function defaultPath(points, curvature) {\n    const [x1, y1, x2, y2] = points;\n    const hx1 = x1 + Math.abs(x2 - x1) * curvature;\n    const hx2 = x2 - Math.abs(x2 - x1) * curvature;\n\n    return `M ${x1} ${y1} C ${hx1} ${y1} ${hx2} ${y2} ${x2} ${y2}`;\n}\n\nexport function renderPathData(emitter, points, connection) {\n    const data = { points, connection, d: '' };\n    \n    emitter.trigger('connectionpath', data);\n    \n    return data.d || defaultPath(points, 0.4);\n}\n\nexport function updateConnection({ el, d }) {\n    const path = el.querySelector('.connection path');\n\n    if (!path) throw new Error('Path of connection was broken');\n\n    path.setAttribute('d', d);\n}\n\nexport function renderConnection({ el, d, connection }) {\n    const classed = !connection?[]:[\n        'input-' + toTrainCase(connection.input.name),\n        'output-' + toTrainCase(connection.output.name),\n        'socket-input-' + toTrainCase(connection.input.socket.name),\n        'socket-output-' + toTrainCase(connection.output.socket.name)\n    ];\n\n    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg')\n    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path')\n\n    svg.classList.add('connection', ...classed);\n    path.classList.add('main-path');\n    path.setAttribute('d', d);\n\n    svg.appendChild(path);\n    el.appendChild(svg);\n\n    updateConnection({ el, d });\n}","import { renderConnection, renderPathData, updateConnection } from './utils';\n\nexport class Picker {\n\n    constructor(editor) {\n        this.el = document.createElement('div');\n        this.editor = editor;\n        this._output = null;\n    }\n\n    get output() {\n        return this._output;\n    }\n\n    set output(val) {\n        const { area } = this.editor.view;\n\n        this._output = val;\n        if (val !== null) {\n            area.appendChild(this.el);\n            this.renderConnection();\n        } else if (this.el.parentElement) {\n            area.removeChild(this.el)\n            this.el.innerHTML = '';\n        }\n    }\n\n    reset() {\n        this.output = null;\n    }\n\n    pickOutput(output) {\n        if (output && !this.output) {\n            this.output = output;\n        }\n    }\n\n    // eslint-disable-next-line max-statements\n    pickInput(input) {\n        if (this.output === null) {\n            if (input.hasConnection()) {\n                this.output = input.connections[0].output;\n                this.editor.removeConnection(input.connections[0]);\n            }\n            return true;\n        }\n\n        if (!input.multipleConnections && input.hasConnection())\n            this.editor.removeConnection(input.connections[0]);\n        \n        if (!this.output.multipleConnections && this.output.hasConnection())\n            this.editor.removeConnection(this.output.connections[0]);\n        \n        if (this.output.connectedTo(input)) {\n            var connection = input.connections.find(c => c.output === this.output);\n\n            this.editor.removeConnection(connection);\n        }\n\n        this.editor.connect(this.output, input);\n        this.reset();\n    }\n\n    pickConnection(connection) {\n        const { output } = connection;\n\n        this.editor.removeConnection(connection);\n        this.output = output;\n    }\n\n    getPoints() {\n        const mouse = this.editor.view.area.mouse;\n        const node = this.editor.view.nodes.get(this.output.node);\n        const [x1, y1] = node.getSocketPosition(this.output);\n\n        return [x1, y1, mouse.x, mouse.y];\n    }\n\n    updateConnection() {\n        if (!this.output) return;\n\n        const d = renderPathData(this.editor, this.getPoints());\n\n        updateConnection({ el: this.el, d });\n    }\n\n    renderConnection() {\n        if (!this.output) return;\n\n        const d = renderPathData(this.editor, this.getPoints());\n\n        renderConnection({ el: this.el, d, connection: null });\n    }\n\n}","import './index.sass'\nimport { renderConnection, renderPathData, updateConnection } from './utils';\nimport { Picker } from './picker';\n\nclass Flow {\n    constructor(picker) {\n        this.picker = picker;\n        this.locked = false;\n    }\n\n    act({ input, output } = {}) {\n        if (this.locked) return;\n        \n        if (input)\n            this.picker.pickInput(input)\n        else if (output)\n            this.picker.pickOutput(output)\n        else\n            this.picker.reset();\n    }\n\n    once(params) {\n        this.act(params);\n        this.prevent();\n    }\n\n    prevent() {\n        this.locked = true;\n    }\n\n    reset() {\n        this.locked = false;\n    }\n}\n\nfunction install(editor) {\n    editor.bind('connectionpath');\n    \n    const picker = new Picker(editor);\n    const flow = new Flow(picker);\n    \n    editor.on('rendersocket', ({ el, input, output }) => {\n        el._reteConnectionPlugin = { input, output };\n\n        el.addEventListener('pointerdown', e => {\n            editor.view.container.dispatchEvent(new PointerEvent('pointermove', e));\n            e.stopPropagation();\n            flow.once(el._reteConnectionPlugin);\n        });\n        el.addEventListener('click', e => {\n            e.stopPropagation();\n            flow.reset();\n        });\n    });\n\n    window.addEventListener('pointerup', e => {\n        const el = document.elementFromPoint(e.clientX, e.clientY);\n\n        flow.act(el && el._reteConnectionPlugin)\n    });\n    window.addEventListener('pointermove', () => flow.reset());\n\n    editor.on('mousemove', () => picker.updateConnection());\n\n    editor.on('renderconnection', ({ el, connection, points }) => {\n        const d = renderPathData(editor, points, connection);\n\n        el.addEventListener('contextmenu', e => {\n            e.stopPropagation();\n            e.preventDefault();\n            \n            picker.pickConnection(connection);\n        });\n\n        renderConnection({ el, d, connection })\n    });\n\n    editor.on('updateconnection', ({ el, connection, points }) => {\n        const d = renderPathData(editor, points, connection);\n\n        updateConnection({ el, connection, d });\n    });\n}\n\nexport default {\n    name: 'connection',\n    install\n}\nexport { defaultPath } from './utils';"],"names":["toTrainCase","str","toLowerCase","replace","defaultPath","points","curvature","x1","y1","x2","y2","hx1","Math","abs","hx2","renderPathData","emitter","connection","data","d","trigger","updateConnection","el","path","querySelector","Error","setAttribute","renderConnection","classed","input","name","output","socket","svg","document","createElementNS","classList","add","appendChild","Picker","editor","createElement","_output","hasConnection","connections","removeConnection","multipleConnections","connectedTo","find","c","connect","reset","mouse","view","area","node","nodes","get","getSocketPosition","x","y","getPoints","val","parentElement","removeChild","innerHTML","Flow","picker","locked","pickInput","pickOutput","params","act","prevent","install","bind","flow","on","_reteConnectionPlugin","addEventListener","e","container","dispatchEvent","PointerEvent","stopPropagation","once","window","elementFromPoint","clientX","clientY","preventDefault","pickConnection"],"mappings":"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"}